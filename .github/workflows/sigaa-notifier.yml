name: ðŸŽ“ UFCG SIGAA Grade Scraper

on:
  schedule:
    #- cron: "0 9-23 * * *" # 6h-20h BRT
    #- cron: "0 0-2 * * *" # 21h-23h BRT (do dia anterior em UTC)
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  scrape-grades:
    name: ðŸ“Š Executar Scraper de Notas
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # ðŸ“¥ Checkout do cÃ³digo
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      # ðŸ Configurar Python com cache
      - name: ðŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      # ðŸ“¦ Cache para dependÃªncias Python
      - name: ðŸ“¦ Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ðŸŽ­ Cache para binÃ¡rios do Playwright
      - name: ðŸŽ­ Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-chromium-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-playwright-chromium-

      # ðŸ”§ Instalar dependÃªncias Python
      - name: ðŸ”§ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ðŸŽ­ Instalar navegadores Playwright (sÃ³ se necessÃ¡rio)
      - name: ðŸŽ­ Install Playwright browsers
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: |
          playwright install chromium

      # ðŸ’¾ Cache para arquivo de notas
      - name: ðŸ’¾ Cache grades_cache.json
        uses: actions/cache@v4
        with:
          path: grades_cache.json
          key: ${{ runner.os }}-grades-cache-${{ github.run_number }}
          restore-keys: |
            ${{ runner.os }}-grades-cache-

      # ðŸ” Configurar variÃ¡veis de ambiente
      - name: ðŸ” Set environment variables
        env:
          SIGAA_USERNAME: ${{ secrets.SIGAA_USERNAME }}
          SIGAA_PASSWORD: ${{ secrets.SIGAA_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_GROUP_CHAT_ID: ${{ secrets.TELEGRAM_GROUP_CHAT_ID }}
          TELEGRAM_PRIVATE_CHAT_ID: ${{ secrets.TELEGRAM_PRIVATE_CHAT_ID }}
        run: |
          echo "SIGAA_USERNAME=$SIGAA_USERNAME" >> .env
          echo "SIGAA_PASSWORD=$SIGAA_PASSWORD" >> .env
          echo "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN" >> .env
          echo "TELEGRAM_GROUP_CHAT_ID=$TELEGRAM_GROUP_CHAT_ID" >> .env
          echo "TELEGRAM_PRIVATE_CHAT_ID=$TELEGRAM_PRIVATE_CHAT_ID" >> .env

      # ðŸš€ Executar o SIGAA Scraper
      - name: ðŸš€ Run SIGAA Scraper
        run: |
          echo "ðŸŽ¯ Iniciando execuÃ§Ã£o do SIGAA Scraper..."
          python main.py
          echo "âœ… ExecuÃ§Ã£o concluÃ­da com sucesso!"

      # ðŸ“Š Salvar os 2 Ãºltimos logs como artifacts
      - name: ðŸ“Š Save recent logs as artifacts
        if: always()
        run: |
          # Criar diretÃ³rio temporÃ¡rio para os Ãºltimos logs
          mkdir -p temp_logs

          # Copiar apenas os 2 arquivos de log mais recentes
          if [ -d "logs" ] && [ "$(ls -A logs)" ]; then
            # Listar arquivos .log por data de modificaÃ§Ã£o e pegar os 2 mais recentes
            ls -t logs/*.log 2>/dev/null | head -2 | xargs -I {} cp {} temp_logs/ 2>/dev/null || true
            
            # Copiar screenshots de erro se existirem
            find logs -name "*.png" -type f -newer logs/sigaa_scraper.log 2>/dev/null | head -1 | xargs -I {} cp {} temp_logs/ 2>/dev/null || true
            
            echo "ðŸ“ Logs preparados para artifact:"
            ls -la temp_logs/ || echo "Nenhum log encontrado"
          else
            echo "ðŸ“‚ DiretÃ³rio logs nÃ£o encontrado ou vazio"
            touch temp_logs/no_logs_found.txt
          fi

      # ðŸ“¦ Upload dos logs como artifact
      - name: ðŸ“¦ Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: recent-logs-${{ github.run_number }}
          path: temp_logs/
          retention-days: 3
          if-no-files-found: warn # ðŸ“ˆ Resumo da execuÃ§Ã£o
      - name: ðŸ“ˆ Execution Summary
        if: always()
        run: |
          echo "## ðŸ“Š Resumo da ExecuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tempo**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

          # Verificar se logs foram gerados
          if [ -d "logs" ] && [ -f "logs/sigaa_scraper.log" ]; then
            LOG_SIZE=$(wc -l < logs/sigaa_scraper.log 2>/dev/null || echo "0")
            echo "- **Logs**: âœ… Gerados com sucesso ($LOG_SIZE linhas)" >> $GITHUB_STEP_SUMMARY
            echo "- **Artifacts**: ðŸ“¦ Ãšltimos logs salvos como artifacts" >> $GITHUB_STEP_SUMMARY
            
            # Mostrar apenas um resumo das Ãºltimas 3 linhas (nÃ£o todo o log)
            if [ "$LOG_SIZE" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ðŸ” Resumo final do log:" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              tail -3 logs/sigaa_scraper.log 2>/dev/null >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Logs**: âŒ NÃ£o encontrados" >> $GITHUB_STEP_SUMMARY
            echo "- **Artifacts**: ðŸ“¦ Marcador de ausÃªncia de logs salvo" >> $GITHUB_STEP_SUMMARY
          fi

          # InformaÃ§Ãµes sobre cache
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¾ Status do Cache:" >> $GITHUB_STEP_SUMMARY
          if [ -f "grades_cache.json" ]; then
            CACHE_SIZE=$(wc -l < grades_cache.json 2>/dev/null || echo "0")
            echo "- **Cache de Notas**: âœ… Presente ($CACHE_SIZE linhas)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Cache de Notas**: ðŸ†• Primeira execuÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          fi
